#
# bitrise.yml
# Copyright Â© 2019 Netguru Sp. z o.o. All rights reserved.

format_version: 1.3.1
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

trigger_map:

  - push_branch: develop
    workflow: build-staging

  - push_branch: master
    workflow: build-release-candidate

  - pull_request_target_branch: develop
    workflow: build-pull-request

  - pull_request_target_branch: master
    workflow: build-pull-request

app:
  envs:
    - XCODEBUILD_PROJECT: ./Baby Monitor.xcworkspace
    - XCODEBUILD_OPTIONS: _BUILD_NUMBER=$BITRISE_BUILD_NUMBER
    - APP_CENTER_ORG_NAME_ID: office-4dmm

workflows:

  build-staging:
    envs:
      - XCODEBUILD_SCHEME: Staging
      - APP_CENTER_API_TOKEN: $APP_CENTER_API_TOKEN_STAGING
      - APP_CENTER_APP_NAME_ID: $APP_CENTER_APP_NAME_STAGING_ID
    before_run:
      - cache-pull
      - install-appcenter
      - bootstrap-carthage
      - bootstrap-cocoapods-keys
      - test-xcode
      - bootstrap-code-signing
      - archive-xcode
    after_run:
      - cache-push
      - deploy-appcenter
      - deploy-bitriseio
      - notify-slack
      - jira-ticket-transition

  build-release-candidate:
    envs:
      - XCODEBUILD_SCHEME: Production
    before_run:
      - cache-pull
      - bootstrap-carthage
      - bootstrap-cocoapods-keys
      - test-xcode
      - bootstrap-code-signing
      - archive-xcode
    after_run:
      - cache-push
      - deploy-bitriseio
      - notify-slack

  build-pull-request:
    envs:
      - XCODEBUILD_SCHEME: Staging
    before_run:
      - cache-pull
      - bootstrap-carthage
      - bootstrap-cocoapods-keys
      - test-xcode
    after_run:
      - cache-push
      - deploy-bitriseio
      - notify-slack

  cache-pull:
    steps:
      - cache-pull: {}

  cache-push:
    steps:
      - cache-push:
          inputs:
            - cache_paths: |-
                ./Carthage
                ./Pods

  bootstrap-carthage:
    steps:
      - carthage:
          inputs:
            - carthage_command: bootstrap
            - carthage_options: --platform iOS --cache-builds
            - github_access_token: $GITHUB_ACCESS_TOKEN
  
  bootstrap-cocoapods-keys:
    steps:
      - script:
          title: 'bundle-install'
          inputs:
            - content: bundle install
            - script:
                      title: 'copy-dotenv'
                      inputs:
                        - content: cp .env.sample .env
      - cocoapods-install: {}

  bootstrap-code-signing:
    steps:
      - certificate-and-profile-installer: {}

  test-xcode:
    steps:
      - xcode-test:
          inputs:
            - project_path: $XCODEBUILD_PROJECT
            - scheme: $XCODEBUILD_SCHEME
            - xcodebuild_test_options: $XCODEBUILD_OPTIONS
            - generate_code_coverage_files: 'yes'
            - should_build_before_test: 'no'

  archive-xcode:
    steps:
      - xcode-archive@2.4.15:
          inputs:
            - project_path: $XCODEBUILD_PROJECT
            - scheme: $XCODEBUILD_SCHEME
            - xcodebuild_options: $XCODEBUILD_OPTIONS

  install-appcenter:
    steps:
      - script:
          title: 'Install App Center CLI'
          inputs:
            - content: |-
               npm i -D webpack@latest
               npm install -g appcenter-cli

  deploy-appcenter:
    steps:
      - appcenter-app-release:
          inputs:
            - appcenter_api_token: $APP_CENTER_API_TOKEN
            - appcenter_name: $APP_CENTER_APP_NAME_ID
            - appcenter_org: $APP_CENTER_ORG_NAME_ID
            - artifact_path: $BITRISE_IPA_PATH
            - distribution_groups: $APP_CENTER_DISTRIBUTION_GROUP

  deploy-bitriseio:
    steps:
      - deploy-to-bitrise-io:
          inputs:
            - notify_user_groups: none
            - is_enable_public_page: false

  notify-slack:
    steps:
      - slack@2.7.2:
          inputs:
            - webhook_url: $SLACK_WEBHOOK_URL
            - channel: $SLACK_CHANNEL
            - channel_on_error: $SLACK_CHANNEL
            - message: $GIT_CLONE_COMMIT_MESSAGE_SUBJECT
            - author_name: 'Build #$BITRISE_BUILD_NUMBER triggered by $GIT_CLONE_COMMIT_AUTHOR_NAME'
            - title: ''
            - fields: |-
                Branch|${BITRISE_GIT_BRANCH}
                Commit|${BITRISE_GIT_COMMIT}
                Workflow|${BITRISE_TRIGGERED_WORKFLOW_ID}
            - buttons: |-
                View on Bitrise|${BITRISE_BUILD_URL}
                View on App Center|https://appcenter.ms/orgs/${APP_CENTER_ORG_NAME_ID}/apps/${APP_CENTER_APP_NAME_ID}

  jira-ticket-transition:
    steps:
      - git::https://github.com/netguru/bitrise-step-ng-jira-step.git@master:
          title: ng-jira-step
          inputs:
            - host: $JIRA_HOST
            - user: $JIRA_USER
            - api_token: $JIRA_API_TOKEN
            - qa_transition_id: $JIRA_QA_TRANSACTION_ID
            - no_qa_transition_id: $JIRA_NO_QA_TRANSACTION_ID
            - add_bitrise_public_download_url: false
            - extra_info_in_comment: "You can download the build from project's App Center."
